<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Presence Detection with BLE using monitor.sh & Home Assistant | Bas-Man's Ponderings</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.79.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css rel=stylesheet><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/cookie.css><link rel="shortcut icon" href=/images/favicons/favico.ico type=image/x-icon><meta property="og:title" content="Presence Detection with BLE using monitor.sh & Home Assistant"><meta property="og:description" content="I have been running Home Assistant for a while. Things are going well. But I have had some issues with presence detection using the standard device_tracker component. Though I live in a small place, being in Tokyo, Home Assistant sometimes stops detecting phones if they are in an area of the apartment a little away from the Home Assistant server. This I suspect is due to the position of the Raspberry Pi and the building material."><meta property="og:type" content="article"><meta property="og:url" content="https://bas-man.github.io/post/ble-presence-detection-home-assistant/"><meta property="article:published_time" content="2020-11-12T10:35:00+09:00"><meta property="article:modified_time" content="2020-11-12T10:35:00+09:00"><meta itemprop=name content="Presence Detection with BLE using monitor.sh & Home Assistant"><meta itemprop=description content="I have been running Home Assistant for a while. Things are going well. But I have had some issues with presence detection using the standard device_tracker component. Though I live in a small place, being in Tokyo, Home Assistant sometimes stops detecting phones if they are in an area of the apartment a little away from the Home Assistant server. This I suspect is due to the position of the Raspberry Pi and the building material."><meta itemprop=dateModified content="2020-11-12T10:35:00+09:00"><meta itemprop=wordCount content="1774"><meta itemprop=keywords content="Bluetooth,Hassio,Presence,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Presence Detection with BLE using monitor.sh & Home Assistant"><meta name=twitter:description content="I have been running Home Assistant for a while. Things are going well. But I have had some issues with presence detection using the standard device_tracker component. Though I live in a small place, being in Tokyo, Home Assistant sometimes stops detecting phones if they are in an area of the apartment a little away from the Home Assistant server. This I suspect is due to the position of the Raspberry Pi and the building material."><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;if(window.sessionStorage){var GA_SESSION_STORAGE_KEY='ga:clientId';ga('create','UA-166598762-1',{'storage':'none','clientId':sessionStorage.getItem(GA_SESSION_STORAGE_KEY)});ga(function(tracker){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,tracker.get('clientId'));});}
ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Bas-Man's Ponderings</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/projects/ title="Projects page">Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/cheatsheets/ title="Cheat Sheets page">Cheat Sheets</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/docs/ title="Documentation page">Documentation</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li></ul><a href=https://www.github.com/Bas-Man target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://dev.to/basman target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Dev-To link" rel=noopener aria-label="follow on Dev.to——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)"><path d="M7.73 11.93c0 1.72-.02 1.83-.23 2.07-.19.17-.38.23-.76.23l-.51.01-.03-2.27-.02-2.27h.52c.35.0.6.07.77.21.24.21.26.25.26 2.02M22 7.5v9c0 1.11-.89 2-2 2H4c-1.11.0-2-.89-2-2v-9c0-1.11.89-2 2-2h16c1.11.0 2 .89 2 2M8.93 11.73c-.03-1.84-.05-1.99-.29-2.39-.4-.68-.85-.84-2.36-.84H5v7h1.21c1.33.0 1.89-.17 2.29-.71.41-.53.5-.98.43-3.06m4.19-3.23h-1.48c-1.49.0-1.5.0-1.71.28S9.7 9.21 9.7 12v2.96l.27.27c.25.27.31.27 1.71.27h1.44v-1.19l-1.09-.04-1.1-.03V12.6l.68-.03.66-.04v-1.19h-1.39V9.7h2.24V8.5m5.88.06c0-.06-.3-.06-.66-.06l-.68.06-.59 2.35c-.38 1.48-.62 2.27-.67 2.13-.08-.27-1.14-4.44-1.14-4.49.0-.05-.31-.05-.68-.05h-.69l.41 1.55c.2.87.59 2.28.81 3.15.34 1.35.46 1.65.75 1.94.2.22.45.36.61.36.33.0.76-.34.9-.73C17.5 14.5 19 8.69 19 8.56z" fill="#626262"/><rect x="0" y="0" width="24" height="24" fill="rgba(0, 0, 0, 0)"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://flipboard.com/@baspann/coding-kq8v8rh8z?from=share" target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Flipboard link" rel=noopener aria-label="follow on Dev.to——Opens in a new window"><!doctype html><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x31_31-flipboard"><g><g><path d="M26.002 26.001v459.998h459.996V26.001H26.002zm367.997 184H302V302h-92v92.001h-92V118.002h275.999V210.001z" style="fill:#f22c31"/></g></g></g><g id="Layer_1"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">ARTICLES</aside><h1 class="f1 athelas mt3 mb1">Presence Detection with BLE using monitor.sh & Home Assistant</h1><p class=tracked>By <strong>Adam Spann</strong></p><time class="f6 mv4 dib tracked" datetime=2020-11-12T10:35:00+09:00>&nbsp;November 12, 2020<br></time><span class="f6 mv4 dib tracked">- 9 minutes read</span>
<span class="f6 mv4 dib tracked">- 1774 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>I have been running <a href=https://www.home-assistant.io/hassio/>Home Assistant</a> for a while. Things are going well. But I have had some issues with presence detection using the standard <em>device_tracker</em> component. Though I live in a small place, being in Tokyo, Home Assistant sometimes stops detecting phones if they are in an area of the apartment a little away from the Home Assistant server. This I suspect is due to the position of the Raspberry Pi and the building material.</p><p>Doing some research I came across a possible solution using multiple BLE devices. I have opted to use <a href=https://github.com/andrewjfreyer/monitor>Monitor</a> a bash script solution.</p><p>This is a guide mostly for myself. I need to remember how it was setup. My approach has been to try and avoid rewriting my configuration and use most of my existing <em>tracker_device</em> automations.</p><h3 id=setup-mosquitto-mqtt-on-your-home-assistant>Setup Mosquitto (MQTT) on your Home Assistant</h3><p>I configured MQTT to use a username and password. This is all that is really needed to get things started.
If MQTT is already setup. Skip this step.</p><h3 id=hardware>Hardware:</h3><p>In addition to my Home Assistant server. I have:</p><ul><li>Raspberry Pi Zero WH</li><li>Raspberry Pi 2 + Bluetooth dongle</li></ul><p> </p><h3 id=installation>Installation:</h3><h4 id=os>OS:</h4><p>For the most part I followed the guide at Level1Techs.</p><h4 id=setup-your-raspberry-pi-zero-wh>Setup your Raspberry Pi Zero W(H)</h4><ol><li>Download Raspbian</li><li>Image Raspbian</li><li>Mount the Boot Partition</li><li>Create wpa_supplicant.conf with this config:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>country<span style=color:#f92672>=</span>US

ctrl_interface<span style=color:#f92672>=</span>DIR<span style=color:#f92672>=</span>/var/run/wpa_supplicant GROUP<span style=color:#f92672>=</span>netdev

update_config<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>

network<span style=color:#f92672>={</span>

ssid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Wireless Network Name&#34;</span>

psk<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Wireless Network Password&#34;</span>

key_mgmt<span style=color:#f92672>=</span>WPA-PSK

<span style=color:#f92672>}</span>
</code></pre></div><ol start=5><li>touch ssh</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> touch ssh
</code></pre></div><p>Step 5 will enable ssh to your device.</p><h4 id=finding-your-new-pi-on-the-network>Finding your new Pi on the network.</h4><p>If your network is small you can simply run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>arp -a
</code></pre></div><p>This will give you a list of devices currently connected to your network. So run this once before you power up the new Pi.</p><p>After you power up the Pi. Run the <em>arp</em> command again and see which new address appears in your list.</p><p>ssh into the new Pi using the standard username and password. Don&rsquo;t forget to change the password just as a matter of good security practice.</p><h4 id=packages--monitor>Packages / monitor</h4><h5 id=update-system-and-packages>Update system and packages</h5><p>Issue the follow commands</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt update <span style=color:#f92672>&amp;&amp;</span> apt upgrade
apt dist-upgrade
apt install pi-bluetooth
</code></pre></div><p>Next reboot the device and login again once it&rsquo;s up.</p><h5 id=install-git-and-mosquitto>Install git and Mosquitto</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget http://repo.mosquitto.org/debian/mosquitto-repo.gpg.key
sudo apt-key add mosquitto-repo.gpg.key
</code></pre></div><p>If you are running Sketch</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget http://repo.mosquitto.org/debian/mosquitto-stretch.list
</code></pre></div><p>If you are running Buster</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget http://repo.mosquitto.org/debian/mosquitto-buster.list
</code></pre></div><p>then</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt-get update
</code></pre></div><p>If you have any issues. Take a look at <strong>The Level 1 Way</strong> guide listed below. You may need to install some additional packages.</p><h5 id=setup-monitor>Setup Monitor</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pi@raspberrypi:~ $ git clone https://github.com/andrewjfreyer/monitor.git
pi@raspberrypi:~ $ cd monitor/
pi@raspberrypi:~/monitor $ chmod +x ./monitor.sh
pi@raspberrypi:~/monitor $ ./monitor.sh
</code></pre></div><p>I suggest running the command a few times to learn how monitor.sh works. Also this needs to be done to create the initial setup files that we will be editing. You might need to run the command with sudo if you are not logged in as root. When you are satisfied check that <strong>monitor</strong> is running with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl status monitor
</code></pre></div><p>If not:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable monitor
systemctl start monitor
</code></pre></div><p>I will not document how I edited the <strong>/etc/systemd/system/monitor.services</strong> file. You will find information on options that others have used in the links below.</p><p>Next add any BT MAC addresses that you know to the <strong>known_static_addresses</strong> file.</p><p>One thing to note. The <em>alias</em> will be the name of the device in MQTT. If there is no alias, the MAC address will be used. More on this later.</p><p><strong>Updated 2020/Nov/12</strong></p><p>If you are monitoring a <em>Tile Device</em> do not place it in the <strong>known_static_addresses</strong>. This will make monitor see the device twice. Once with confidence 100% and again with 0%. The work a round that I have seen it to not place its MAC address in the file. You will need to use the MAC address instead of an alias in the sensor configuration.</p><p><strong>References</strong></p><ul><li><a href=https://community.home-assistant.io/t/bluetooth-le-tracker-issues/97705/33>1. Home Assistant Community - Bluetooth-le-Tracking-Issues</a></li><li><a href=https://community.home-assistant.io/t/monitor-reliable-multi-user-distributed-bluetooth-occupancy-presence-detection/68505/1416>2. Home Assistant Community - monitor-reliable-multi-user-distributed-bluetooth-occupancy-presence-detection</a></li><li><a href=https://github.com/andrewjfreyer/monitor/issues/183>3. GitHub - Active scanner + overrule HA &lsquo;consider_home&rsquo; #183</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ---------------------------</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># STATIC MAC ADDRESS LIST</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># 00:00:00:00:00:00 Alias #comment</span>
<span style=color:#75715e># ---------------------------</span>
 00:00:00:00:00:00 person1_Phone

</code></pre></div><p>Configure <strong>mqtt_preferences</strong> so that we can connect and publish to our MQTT topics. </p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ---------------------------</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># MOSQUITTO PREFERENCES</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># ---------------------------</span>

<span style=color:#75715e># IP ADDRESS OR HOSTNAME OF MQTT BROKER</span>
mqtt_address<span style=color:#f92672>=</span>192.168.X.X

<span style=color:#75715e># MQTT BROKER USERNAME</span>
mqtt_user<span style=color:#f92672>=</span>mqtt_username <span style=color:#75715e># This is what was configured on the MQTT Server.</span>

<span style=color:#75715e># MQTT BROKER PASSWORD</span>
mqtt_password<span style=color:#f92672>=</span>password <span style=color:#75715e>#Same case as username.</span>

<span style=color:#75715e># MQTT PUBLISH TOPIC ROOT</span>
mqtt_topicpath<span style=color:#f92672>=</span>monitor <span style=color:#75715e># &lt;- most configs use this.</span>

<span style=color:#75715e># PUBLISHER IDENTITY</span>
mqtt_publisher_identity<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;livingarea&#39;</span> <span style=color:#75715e>#&lt;- ID for one of the Pi servers eg. Pi Zero W</span>

<span style=color:#75715e># MQTT PORT</span>
mqtt_port<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1883&#39;</span>

<span style=color:#75715e># MQTT CERTIFICATE FILE</span>
mqtt_certificate_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>

<span style=color:#75715e>#MQTT VERSION (EXAMPLE: &#39;mqttv311&#39;)</span>
mqtt_version<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</code></pre></div><h4 id=note>Note:</h4><p><strong>mqtt_topicpath</strong> should be the same on each of your monitoring servers.</p><p><strong>mqtt_publisher_identity</strong> must be unique for each server that will be sending MQTT messages to the HA server.</p><p>Test that MQTT server is getting the new notifications from your Pi devices.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mosquitto_sub -h 192.168.X.X -u username -P passwd -t monitor/#

<span style=color:#75715e># Output</span>
<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;00:00:00:00:00:00&#34;</span>,<span style=color:#e6db74>&#34;confidence&#34;</span>:<span style=color:#e6db74>&#34;100&#34;</span>,<span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;person1_Phone&#34;</span>,<span style=color:#e6db74>&#34;manufacturer&#34;</span>:<span style=color:#e6db74>&#34;Apple Inc&#34;</span>,<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;KNOWN_MAC&#34;</span>,<span style=color:#e6db74>&#34;retained&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#e6db74>&#34;timestamp&#34;</span>:<span style=color:#e6db74>&#34;Fri Nov 06 2020 1
</span></code></pre></div><p>Here we can see that devices are being seen and their <em>confidence level</em> from the <em>monitor.sh</em> is being reported.</p><p>At this point, after setting up all of the monitoring devices, it is time to move onto setting up HA.</p><h3 id=home-assistant-configuration>Home Assistant Configuration.</h3><h4 id=setup-the-sensor-part-of-the-configuration>Setup the sensor part of the configuration.</h4><p>We need to collect the MQTT messages into HA</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>mqtt</span>
  <span style=color:#f92672>state_topic</span>: <span style=color:#e6db74>&#39;monitor/front/person1_phone&#39;</span>
  <span style=color:#f92672>value_template</span>: <span style=color:#e6db74>&#39;{{ value_json.confidence }}&#39;</span>
  <span style=color:#f92672>unit_of_measurement</span>: <span style=color:#e6db74>&#39;%&#39;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;Person1 Phone Front&#39;</span>

- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>mqtt</span>
  <span style=color:#f92672>state_topic</span>: <span style=color:#e6db74>&#39;monitor/livingarea/person1_phone&#39;</span>
  <span style=color:#f92672>value_template</span>: <span style=color:#e6db74>&#39;{{ value_json.confidence }}&#39;</span>
  <span style=color:#f92672>unit_of_measurement</span>: <span style=color:#e6db74>&#39;%&#39;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;Person1 Phone Living Area&#39;</span>

</code></pre></div><h4 id=added-2020nov12>Added 2020/Nov/12</h4><h5 id=tile-device-example>Tile Device Example</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>mqtt</span>
  <span style=color:#f92672>state_topic</span>: <span style=color:#e6db74>&#39;monitor/front/XX::XX:XX:XX:XX:XX&#39;</span>
  <span style=color:#f92672>value_template</span>: <span style=color:#e6db74>&#39;{{ value_json.confidence }}&#39;</span>
  <span style=color:#f92672>unit_of_measurement</span>: <span style=color:#e6db74>&#39;%&#39;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;Person1 Phone Front&#39;</span>

- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>mqtt</span>
  <span style=color:#f92672>state_topic</span>: <span style=color:#e6db74>&#39;monitor/livingarea/XX::XX:XX:XX:XX:XX&#39;</span>
  <span style=color:#f92672>value_template</span>: <span style=color:#e6db74>&#39;{{ value_json.confidence }}&#39;</span>
  <span style=color:#f92672>unit_of_measurement</span>: <span style=color:#e6db74>&#39;%&#39;</span>
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;Person1 Phone Living Area&#39;</span>
</code></pre></div><p><strong>Note:</strong></p><ol><li>I have two entries as I have two devices running <strong>monitor</strong> in two locations in my home.</li><li>The topic is <em>person1_phone</em> which matches the alias used in the <strong>known_static_addresses</strong> file. If there was not an alias. These would be the actual MAC Addresses.</li></ol><p>The next part is still a work in progress. This is still in the sensor.yaml file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>min_max</span>
   <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Person1 Phone Home Confidence&#34;</span>
   <span style=color:#f92672>type</span>: <span style=color:#ae81ff>mean</span>
   <span style=color:#f92672>round_digits</span>: <span style=color:#ae81ff>0</span>
   <span style=color:#f92672>entity_ids</span>:
     - <span style=color:#ae81ff>sensor.person1_phone_front</span>
     - <span style=color:#ae81ff>sensor.person1_phone_living_area</span>
</code></pre></div><p>This combines these two sensors and return the mean of their two values. In my case this often returns 50% since only one monitor server can detect the phone based on where it is.</p><p>Next we create a sensor that will return a &lsquo;True&rsquo; or &lsquo;False&rsquo; state. As mentioned my min_max generally returns 50%. So I want to have &lsquo;True&rsquo; if the value is > 45% for safety.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>template</span>
  <span style=color:#f92672>sensors</span>:
    <span style=color:#f92672>is_person1_home</span>:
      <span style=color:#f92672>friendly_name</span>: <span style=color:#e6db74>&#39;Is Person1 Home?&#39;</span>
      <span style=color:#f92672>value_template</span>: <span style=color:#e6db74>&#39;{{ state_attr(&#34;sensor.person1_home_confidence&#34;,&#34;mean&#34;) | float &gt; 45 }}&#39;</span>
</code></pre></div><p>The <strong>value_template</strong> could probably be changed to
<em>states(&lsquo;sensor.person1_home_confidence&rsquo;)</em>.</p><p>At this point we have a sensor that returns true or false if it can see the bluetooth device we are looking for. But it&rsquo;s not actually connected to any HA automations.</p><p>In my existing configuration I am using</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>bluetooth_le_tracker</span>

- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>bluetooth_tracker</span>
</code></pre></div><p>Which auto populates the <strong>known_devices</strong> file.
These devices are then used as triggers for my automations. I want to avoid making larges changes. So we are going to make some virtual device_trackers. These will replace the ones created using the provided bluetooth trackers.</p><p>In the <strong>devices_tracker</strong> configuration file we will add something like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>mqtt</span>
  <span style=color:#f92672>source_type</span>: <span style=color:#e6db74>&#39;bluetooth&#39;</span>
  <span style=color:#f92672>devices</span>:
    <span style=color:#f92672>person1</span>: <span style=color:#e6db74>&#39;location/person1&#39;</span>
</code></pre></div><p>We are basically saying that we are want an MQTT Topic called location/person1. We will be publishing state to this with some scripts later.</p><p>This is where I actually got stuck and it wasn&rsquo;t until I found <a href=https://community.home-assistant.io/t/combining-multiple-device-trackers-into-one-using-mqtt/45324>this bit of wisdom</a> that things fell into place.</p><p>We need to manaully add entries to the <strong>known_devices</strong> file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>person1</span>:
  <span style=color:#f92672>hide_if_away</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>icon</span>:
  <span style=color:#f92672>mac</span>:
  <span style=color:#f92672>picture</span>:
  <span style=color:#f92672>vendor</span>:
  <span style=color:#f92672>track</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Test Person</span>
</code></pre></div><p>We now have a <strong>device_tracker.person1</strong> which will have its state taken from <strong>MQTT:location/person1</strong></p><p><strong>Note:</strong></p><p>If you test this state you will get a <strong>source: null</strong>. This will not be set until we first publish to MQTT.</p><h4 id=moving-on-to-the-scripts>Moving on to the scripts</h4><p>Now we need to start being able to update the <strong>MQTT:location/person1</strong> so that <strong>device_tracker.person1</strong> will have either a <strong>&lsquo;home&rsquo;</strong> or <strong>&lsquo;not_home&rsquo;</strong> state.</p><p>We will edit our script configuration files.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>&#39;person1_home&#39;</span>:
  <span style=color:#f92672>alias</span>: <span style=color:#e6db74>&#34;Person1 Home&#34;</span>
  <span style=color:#f92672>sequence</span>:
    - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>mqtt.publish</span>
      <span style=color:#f92672>data</span>:
        <span style=color:#f92672>topic</span>: <span style=color:#ae81ff>location/person1</span>
        <span style=color:#f92672>payload</span>: <span style=color:#e6db74>&#39;home&#39;</span>

<span style=color:#f92672>&#39;person1_away&#39;</span>:
  <span style=color:#f92672>alias</span>: <span style=color:#e6db74>&#34;Person1 away&#34;</span>
  <span style=color:#f92672>sequence</span>:
    - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>mqtt.publish</span>
      <span style=color:#f92672>data</span>:
        <span style=color:#f92672>topic</span>: <span style=color:#ae81ff>location/person1</span>
        <span style=color:#f92672>payload</span>: <span style=color:#e6db74>&#39;not_home&#39;</span>

</code></pre></div><p>These two scripts will update the device_tracker so that we can use their state. We will need an automation so that the state is updated.</p><p>But I will add a bonus script here as well. This will trigger a bluetooth rescan. This can be triggered on a restart of HA with an automation.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>&#39;bt_rescan&#39;</span>:
  <span style=color:#f92672>alias</span>: <span style=color:#e6db74>&#34;Issue BT Rescan&#34;</span>
  <span style=color:#f92672>sequence</span>:
    - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>mqtt.publish</span>
      <span style=color:#f92672>data</span>:
        <span style=color:#f92672>topic</span>: <span style=color:#ae81ff>monitor/scan/restart</span>
        <span style=color:#f92672>payload</span>: <span style=color:#e6db74>&#39;&#39;</span>
</code></pre></div><p>Add the following configuration to automations.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>alias</span>: <span style=color:#ae81ff>Set Person home</span>
  <span style=color:#f92672>initial_state</span>: <span style=color:#e6db74>&#39;on&#39;</span>
  <span style=color:#f92672>trigger</span>:
    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>state</span>
      <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>sensor.is_person1_home</span>
    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
      <span style=color:#f92672>event</span>: <span style=color:#ae81ff>start</span>
  <span style=color:#f92672>condition</span>:
    - <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>state</span>
      <span style=color:#f92672>entity_id</span>: <span style=color:#e6db74>&#39;sensor.is_person1_home&#39;</span>
      <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#39;True&#39;</span>
  <span style=color:#f92672>action</span>:
    - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>script.person1_home</span>

- <span style=color:#f92672>alias</span>: <span style=color:#ae81ff>Set Person1 away</span>
  <span style=color:#f92672>initial_state</span>: <span style=color:#e6db74>&#39;on&#39;</span>
  <span style=color:#f92672>trigger</span>:
    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>state</span>
      <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>sensor.is_person1_home</span>
    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
      <span style=color:#f92672>event</span>: <span style=color:#ae81ff>start</span>
  <span style=color:#f92672>condition</span>:
    - <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>state</span>
      <span style=color:#f92672>entity_id</span>: <span style=color:#e6db74>&#39;sensor.is_person1_home&#39;</span>
      <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#39;False&#39;</span>
  <span style=color:#f92672>action</span>:
    - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>script.person1_away</span>
</code></pre></div><p>This is where we link everything together. We also have the automations trigger when HA starts up. So we get some initial state.</p><p>I personally also opted to have a BT scan triggered when ever HA restarts.</p><p>I added this configuration to automations.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>alias</span>: <span style=color:#e6db74>&#34;HA Started&#34;</span>
<span style=color:#f92672>initial_state</span>: <span style=color:#e6db74>&#39;on&#39;</span>
<span style=color:#f92672>trigger</span>:
  <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
  <span style=color:#f92672>event</span>: <span style=color:#ae81ff>start</span>
<span style=color:#f92672>action</span>:
  - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>script.bt_rescan</span>
</code></pre></div><p>The final step is the replace all the previous device_tracker references with the new manaully created ones listed in <strong>known_devices.yaml</strong></p><h3 id=final-thoughts>Final Thoughts</h3><p>This is not yet an Ideal setup. I am still working on it. But if you look at the blog links below you might get some more ideas. I am still reading through them and improving things.</p><p>As I stated at the start. This is mostly for me so that I have some documentation for myself.</p><p>But I hope others might find it useful. Since I had to work through it and piece it together.</p><p>Thanks to those who posted the work online. It was invaluable. The main part I found missing was the <strong>known_devices.yaml</strong></p><h3 id=references>References:</h3><ul><li><p><a href=https://forum.level1techs.com/t/bluetooth-presence-detection-for-home-automation-the-level1-way/148516>Bluetooth Presence Detection for Home Automation – The Level1 Way</a></p></li><li><p><a href=https://community.home-assistant.io/t/monitor-reliable-multi-user-distributed-bluetooth-occupancy-presence-detection/68505>[monitor] Reliable, Multi-User, Distributed Bluetooth Occupancy/Presence Detection</a></p></li></ul><h4 id=these-are-links-to-a-single-ha-user-the-config-is-far-beyond-what-i-need-but-its-a-great-resource>These are links to a single HA user. The config is far beyond what I need. But it&rsquo;s a great resource.</h4><ul><li><a href=https://blog.ceard.tech/2019/03/presence-detection-are-we-nearly-there.html>Presence detection - are we nearly there yet?</a></li><li><a href=https://blog.ceard.tech/2019/10/presence-detection-final-countdown.html>Presence detection, the final countdown?</a></li><li><a href=https://blog.ceard.tech/2018/09/a-while-back-i-covered-how-i-was-doing.html>Presence detection updated</a></li><li><a href=https://github.com/DubhAd/Home-AssistantConfig>GitHub Repo</a></li></ul><h4 id=some-missing-magic>Some missing Magic.</h4><ul><li><a href=https://community.home-assistant.io/t/combining-multiple-device-trackers-into-one-using-mqtt/45324>The missing magic to make MQTT State usable as a device_tracker</a></li></ul><h3 id=software>Software:</h3><ul><li><a href=https://github.com/andrewjfreyer/monitor>Monitor</a></li></ul><ul class=pa0><li class=list><a href=/tags/bluetooth class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Bluetooth</a></li><li class=list><a href=/tags/hassio class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Hassio</a></li><li class=list><a href=/tags/presence class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Presence</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://bas-man.github.io/>&copy; Bas-Man's Ponderings 2020</a>
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://bas-man.github.io//privacy>Privacy</a><div><a href=https://www.github.com/Bas-Man target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://dev.to/basman target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Dev-To link" rel=noopener aria-label="follow on Dev.to——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)"><path d="M7.73 11.93c0 1.72-.02 1.83-.23 2.07-.19.17-.38.23-.76.23l-.51.01-.03-2.27-.02-2.27h.52c.35.0.6.07.77.21.24.21.26.25.26 2.02M22 7.5v9c0 1.11-.89 2-2 2H4c-1.11.0-2-.89-2-2v-9c0-1.11.89-2 2-2h16c1.11.0 2 .89 2 2M8.93 11.73c-.03-1.84-.05-1.99-.29-2.39-.4-.68-.85-.84-2.36-.84H5v7h1.21c1.33.0 1.89-.17 2.29-.71.41-.53.5-.98.43-3.06m4.19-3.23h-1.48c-1.49.0-1.5.0-1.71.28S9.7 9.21 9.7 12v2.96l.27.27c.25.27.31.27 1.71.27h1.44v-1.19l-1.09-.04-1.1-.03V12.6l.68-.03.66-.04v-1.19h-1.39V9.7h2.24V8.5m5.88.06c0-.06-.3-.06-.66-.06l-.68.06-.59 2.35c-.38 1.48-.62 2.27-.67 2.13-.08-.27-1.14-4.44-1.14-4.49.0-.05-.31-.05-.68-.05h-.69l.41 1.55c.2.87.59 2.28.81 3.15.34 1.35.46 1.65.75 1.94.2.22.45.36.61.36.33.0.76-.34.9-.73C17.5 14.5 19 8.69 19 8.56z" fill="#626262"/><rect x="0" y="0" width="24" height="24" fill="rgba(0, 0, 0, 0)"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://flipboard.com/@baspann/coding-kq8v8rh8z?from=share" target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Flipboard link" rel=noopener aria-label="follow on Dev.to——Opens in a new window"><!doctype html><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x31_31-flipboard"><g><g><path d="M26.002 26.001v459.998h459.996V26.001H26.002zm367.997 184H302V302h-92v92.001h-92V118.002h275.999V210.001z" style="fill:#f22c31"/></g></g></g><g id="Layer_1"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer><script src=/dist/js/app.3fc0f988d21662902933.js></script><div class=cookie-container><p>By using this site, you agree to our use of cookies.
We use cookies on this website to give you the best experience on our
site. To find out more, read our <a href=/privacy/>privacy</a> policy.</p><button class=cookie-btn>
Okay</button></div><script src=/my_js/cookie.js></script></body></html>