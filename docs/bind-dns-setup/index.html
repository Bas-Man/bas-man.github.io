<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Bind DNS Setup - Bas-Man's Musings</title><meta name=description content="A guide on setting up a caching and authoritative name server."><meta name=author content="Bas-Man"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Bas-Man\u0027s Musings","url":"https:\/\/bas-man.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/bas-man.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/bas-man.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/bas-man.github.io\/docs\/bind-dns-setup\/","name":"Bind DNS setup"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Bas-Man"},"headline":"Bind DNS Setup","description":"A guide on setting up a caching and authoritative name server.","inLanguage":"en","wordCount":3169,"datePublished":"2020-11-27T17:30:00","dateModified":"2020-11-27T17:30:00","image":"https:\/\/bas-man.github.io\/","keywords":[""],"mainEntityOfPage":"https:\/\/bas-man.github.io\/docs\/bind-dns-setup\/","publisher":{"@type":"Organization","name":"https:\/\/bas-man.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/bas-man.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="Bind DNS Setup"><meta property="og:description" content="A guide on setting up a caching and authoritative name server."><meta property="og:url" content="https://bas-man.github.io/docs/bind-dns-setup/"><meta property="og:type" content="website"><meta property="og:site_name" content="Bas-Man's Musings"><meta name=twitter:title content="Bind DNS Setup"><meta name=twitter:description content="A guide on setting up a caching and authoritative name server."><meta name=twitter:card content="summary"><link href=https://bas-man.github.io/images/favicons/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.83.1"><link rel=alternate href=https://bas-man.github.io/index.xml type=application/rss+xml title="Bas-Man's Musings"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://bas-man.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://bas-man.github.io/css/highlight.min.css><link rel=stylesheet href=https://bas-man.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/custom.css><link href=/css/boxes.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-166598762-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CBZDLNDS8"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-CBZDLNDS8')</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://bas-man.github.io/>Bas-Man's Musings</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Home href=/>Home</a></li><li class=navlinks-container><a class=navlinks-parent>Categories</a><div class=navlinks-children><a href=/series>Series</a>
<a href=/categories>Categories</a>
<a href=/tags>Tags</a></div></li><li class=navlinks-container><a class=navlinks-parent>Projects</a><div class=navlinks-children><a href=/projects/github/>GitHub</a>
<a href=/projects/line-notify-from-email/>Line Notification</a></div></li><li class=navlinks-container><a class=navlinks-parent>Docs</a><div class=navlinks-children><a href=/docs/bind-dns-setup/>Bind DNS Setup</a>
<a href=/docs/gmail-zapier-line-notify/>Gmail & Zapier</a></div></li><li class=navlinks-container><a class=navlinks-parent>References</a><div class=navlinks-children><a href=/cheatsheets/python/>Python</a>
<a href=/cheatsheets/perl/>Perl</a>
<a href=/cheatsheets/rust/>Rust</a>
<a href=/cheatsheets/git/>Git</a>
<a href=/cheatsheets/latex/>LaTeX</a></div></li><li class=navlinks-container><a class=navlinks-parent>Snippets</a><div class=navlinks-children><a href=/cheatsheets/python/snippets/>Python</a>
<a href=/cheatsheets/perl/snippets/>Perl</a>
<a href=/cheatsheets/rust/snippets/>Rust</a>
<a href=/cheatsheets/git/snippets/>Git</a></div></li><li><a title=About href=/about/>About</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=docs-heading><h1>Bind DNS Setup</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h2 id=warning>Warning!</h2><p>This guide is only intended for those that plan to use these servers within their own networks running behind a NAT router. Or with the service only available on the internal interfaces. This configure is not intended on WAN (Wide Area Network) interfaces.
This is written for myself. And if you are looking for a DNS guide. You might consider looking at the guides I list in the references section.</p><h3 id=installation>Installation:</h3><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  apt update <span class=o>&amp;&amp;</span> apt upgrade
  apt install bind9 dnsutils
</code></pre></div><p>This will update the the server so that we have the latest patched modules and libraries and then install Bind9.</p><h3 id=configuration>Configuration.</h3><h4 id=some-assumptions>Some Assumptions.</h4><p>Whilst assumptions are the mother of all hiccups. I will make a few.</p><ul><li>You have not set up Bind previously.</li><li>Your network address space is 192.168.11.0/24</li><li>You have chosen two servers for your DNS services.<ul><li>192.168.11.10 (Primary)</li><li>192.168.11.20 (Secondary)</li></ul></li><li>Please change these in your setting to match your own network.</li></ul><h4 id=toolscommands-that-we-will-be-using>Tools/commands that we will be using:</h4><ul><li>dig</li><li>nslookup (alternative to dig)</li><li>named-checkconf</li><li>named-checkzone</li><li>systemd-resolve &ndash;status</li></ul><h4 id=important-files>Important files</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  /etc/default/bind9
  /etc/bind/*
</code></pre></div><p><strong>/etc/default/bind9</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># run resolvconf?</span>
<span class=nv>RESOLVCONF</span><span class=o>=</span>no

<span class=c1># startup options for the server</span>
<span class=nv>OPTIONS</span><span class=o>=</span><span class=s2>&#34;-u bind&#34;</span>

</code></pre></div><p>This file is where we can set additional options which are passed to bind on startup. We can specify if our network is IP4 only and if we want to run the service chrooted. I will not go into that here. I am assuming that the DNS server will only be used internally behind a NAT router and not exposed to the internet. Thus additional security is not required.</p><h4 id=etcbind>/etc/bind/</h4><p><strong>named.conf</strong>
This is the main configuration file. We can break this into multiple files which can be included in <strong>named.conf</strong> by using the <strong>include</strong> directive.</p><p>Let&rsquo;s start by creating a file that will contain our ACLs (Access Control List) and add the following contents.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi named.conf.acl
</code></pre></div><p>Then add the following contents. This will be used to allow DNS to make external lookups for the address ranges specified. This is very important if your DNS server is exposed on the internet. Not really needed if it is not exposed.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>acl <span class=s2>&#34;internal&#34;</span> <span class=o>{</span>
	192.168.11.0/24<span class=p>;</span> <span class=c1># Local Area Network.</span>
	127.0.0.1<span class=p>;</span> <span class=c1># Localhost</span>
<span class=o>}</span><span class=p>;</span>

</code></pre></div><p>Next we want to add this to our <strong>named.conf</strong> file.
Let&rsquo;s add this to the top of the file.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>include <span class=s2>&#34;/etc/bind/named.conf.acl&#34;</span><span class=p>;</span>
</code></pre></div><p><strong>named.conf</strong> will now load this information as part of its configuration.</p><p>The <strong>named.conf</strong> file should now look something like this:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>// This is the primary configuration file <span class=k>for</span> the BIND DNS server named.
//
// Please <span class=nb>read</span> /usr/share/doc/bind9/README.Debian.gz <span class=k>for</span> information on the
// structure of BIND configuration files in Debian, *BEFORE* you customize
// this configuration file.
//
// If you are just adding zones, please <span class=k>do</span> that in /etc/bind/named.conf.local

include <span class=s2>&#34;/etc/bind/named.conf.acl&#34;</span><span class=p>;</span>

include <span class=s2>&#34;/etc/bind/named.conf.options&#34;</span><span class=p>;</span>
include <span class=s2>&#34;/etc/bind/named.conf.local&#34;</span><span class=p>;</span>
include <span class=s2>&#34;/etc/bind/named.conf.default-zones&#34;</span><span class=p>;</span>
</code></pre></div><p>There is no more work to be done with the <strong>named.conf</strong> file. So we will not be looking at it again. You can and probably should check that the configuration file has not problems by using this command.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>named-checkconf
</code></pre></div><p>This will report errors and their line number.</p><p><strong>named.conf.options</strong></p><p>Let&rsquo;s turn to the options file.
The default version will look something like this:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>options <span class=o>{</span>
	directory <span class=s2>&#34;/var/cache/bind&#34;</span><span class=p>;</span>

	// If there is a firewall between you and nameservers you want
	// to talk to, you may need to fix the firewall to allow multiple
	// ports to talk.  See http://www.kb.cert.org/vuls/id/800113

	// If your ISP provided one or more IP addresses <span class=k>for</span> stable
	// nameservers, you probably want to use them as forwarders.
	// Uncomment the following block, and insert the addresses replacing
	// the all-0s placeholder.

	// forwarders <span class=o>{</span>
	// 	0.0.0.0<span class=p>;</span>
	// <span class=o>}</span><span class=p>;</span>
...
...
<span class=o>}</span><span class=p>;</span>
</code></pre></div><p>Lets add some options just below the <strong>directory</strong> option:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>    recursion yes<span class=p>;</span>
    allow-recursion <span class=o>{</span> internal<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
    listen-on <span class=o>{</span> 127.0.0.1<span class=p>;</span> 192.168.11.10<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
    allow-transfer <span class=o>{</span> none<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</code></pre></div><h4 id=what-do-these-options-mean>What do these options mean?</h4><ol><li>Enable recursion so that the server can make lookups for us.</li><li>Limit the addresses that can do recursive lookups to the addresses we specified using the <strong>internal</strong> ACL.</li><li>Listen for and answer DNS queries that come in. Limited to the internal loopback address and the main interface address. If you do not want to restrict the listen-on interfaces, use a value of <strong>any;</strong></li><li>Don&rsquo;t allow zone transfers to secondary DNS servers. This can and will be adjust on a zone by zone basis later if you configure a secondary name server for your network.</li></ol><p>Next look at the <strong>forwarder</strong> portion. This is were we can tell the DNS server who it should go and ask to make lookups on its behalf if it doesn&rsquo;t already know the answer. Either because it is not the authoritative server or does not have a cache record. This would generally be your ISP&rsquo;s name servers. But you are free to use others. Such as <strong>8.8.8.8</strong> and other public DNS servers. Though using a name server that is not local or part of your normal service is generally frowned upon and could also result in slow lookups.</p><p>The primary benefit of using forwarders is that hopefully someone else has already made the same DNS lookup using that server. The server will probably therefore already have a cached answer. This results in a faster lookup. Though it is not required for operations as the name server is able to query the root servers. Though this is going the long way around when a cached answer is probably only a single server away.</p><p>Let&rsquo;s remove the // characters which are comment markers and add some addresses.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>    forwarders <span class=o>{</span>
      8.8.8.8<span class=p>;</span>
      x.x.x.x<span class=p>;</span>
    <span class=o>}</span><span class=p>;</span>

</code></pre></div><p>Save the file and again use the <strong>named-checkconf</strong> command to make sure no errors have been introduced.</p><p><strong>Warning:</strong>
You might hit an issue during testing. You might find that lookup work without any forwarders set, but fail with them set.</p><p>If you want to use forwarders. The work around here is as follows:</p><p><strong>Reference:</strong> <a href=https://serverfault.com/questions/429757/bind9-forwarders-are-not-working>ServerFault Link</a></p><p>Update the <strong>dnssec-validation</strong> line.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>    //dnssec-validation auto<span class=p>;</span>
    dnssec-validation no<span class=p>;</span>
</code></pre></div><p>The other option is to not use forwarders and let your server query the root name servers as needed.</p><p>At this point you basically have a caching server configuration. It might be a good idea to test that it&rsquo;s working. Let&rsquo;s start bind.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl <span class=nb>enable</span> bind9
systemctl start bind9
</code></pre></div><p>At the moment the server itself doesn&rsquo;t know to use the newly configured bind service. But we can cheat here. And actually this is useful trick when you are testing DNS related issues.
We can use the <strong>dig</strong> command.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dig www.google.com @localhost

</code></pre></div><p>The <strong>@localhost</strong> is saying we want to specifically sent our DNS query to the localhost without using the <strong>/etc/resolv.conf</strong> file.</p><p>Which should give you output similar to the text below. This will be different</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Raspbian &lt;&lt;&gt;&gt; www.google.com @localhost
<span class=p>;;</span> global options: +cmd
<span class=p>;;</span> Got answer:
<span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>18246</span>
<span class=p>;;</span> flags: qr rd ra<span class=p>;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 13, ADDITIONAL: <span class=m>27</span>

<span class=p>;;</span> OPT PSEUDOSECTION:
<span class=p>;</span> EDNS: version: 0, flags:<span class=p>;</span> udp: <span class=m>4096</span>
<span class=p>;;</span> QUESTION SECTION:
<span class=p>;</span>www.google.com.			IN	A

<span class=p>;;</span> ANSWER SECTION:
www.google.com.		86	IN	A	172.217.24.132

<span class=p>;;</span> AUTHORITY SECTION:
.			411182	IN	NS	b.root-servers.net.
.			411182	IN	NS	h.root-servers.net.
.			411182	IN	NS	g.root-servers.net.
.			411182	IN	NS	l.root-servers.net.
.			411182	IN	NS	j.root-servers.net.
.			411182	IN	NS	f.root-servers.net.
.			411182	IN	NS	e.root-servers.net.
.			411182	IN	NS	k.root-servers.net.
.			411182	IN	NS	a.root-servers.net.
.			411182	IN	NS	i.root-servers.net.
.			411182	IN	NS	d.root-servers.net.
.			411182	IN	NS	m.root-servers.net.
.			411182	IN	NS	c.root-servers.net.

<span class=p>;;</span> ADDITIONAL SECTION:
a.root-servers.net.	335582	IN	A	198.41.0.4
a.root-servers.net.	335424	IN	AAAA	2001:503:ba3e::2:30
b.root-servers.net.	336203	IN	A	199.9.14.201
b.root-servers.net.	335567	IN	AAAA	2001:500:200::b
c.root-servers.net.	335601	IN	A	192.33.4.12
c.root-servers.net.	335299	IN	AAAA	2001:500:2::c
d.root-servers.net.	343081	IN	A	199.7.91.13
d.root-servers.net.	343973	IN	AAAA	2001:500:2d::d
e.root-servers.net.	336987	IN	A	192.203.230.10
e.root-servers.net.	336987	IN	AAAA	2001:500:a8::e
f.root-servers.net.	335460	IN	A	192.5.5.241
f.root-servers.net.	335895	IN	AAAA	2001:500:2f::f
g.root-servers.net.	336203	IN	A	192.112.36.4
g.root-servers.net.	335863	IN	AAAA	2001:500:12::d0d
h.root-servers.net.	335567	IN	A	198.97.190.53
h.root-servers.net.	335785	IN	AAAA	2001:500:1::53
i.root-servers.net.	335363	IN	A	192.36.148.17
i.root-servers.net.	335424	IN	AAAA	2001:7fe::53
j.root-servers.net.	335298	IN	A	192.58.128.30
j.root-servers.net.	335785	IN	AAAA	2001:503:c27::2:30
k.root-servers.net.	335460	IN	A	193.0.14.129
k.root-servers.net.	335567	IN	AAAA	2001:7fd::1
l.root-servers.net.	335601	IN	A	199.7.83.42
l.root-servers.net.	335443	IN	AAAA	2001:500:9f::42
m.root-servers.net.	343973	IN	A	202.12.27.33
m.root-servers.net.	343835	IN	AAAA	2001:dc3::35

<span class=p>;;</span> Query time: <span class=m>33</span> msec
<span class=p>;;</span> SERVER: ::1#53<span class=o>(</span>::1<span class=o>)</span>
<span class=p>;;</span> WHEN: Sat Nov <span class=m>21</span> 23:37:26 JST <span class=m>2020</span>
<span class=p>;;</span> MSG SIZE  rcvd: <span class=m>842</span>
</code></pre></div><p>Now we have a working caching name server. Time to make the server use it for its own DNS lookups.</p><h3 id=modifying-etcresolvconf>Modifying /etc/resolv.conf</h3><p>There seems to be a few ways to do this.</p><ol><li>Edit the file manually. An acceptable option if you are setting your network statically.
2.Change the name server information at the source. The DHCP server that provides it.</li><li>Modify <strong>/etc/dhcpcd.conf</strong> if you are assigning host addresses and name servers using dhcp.</li><li>Using <strong>netplan</strong>. Unfortunately this is new to me and I have not had a chance to look into it.</li></ol><p>If you do not have a <strong>/etc/dhcpcd.conf</strong> you can install and configure it using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>apt install dhcpcd
systemctl <span class=nb>enable</span> dhcpcd
systemctl start dhcpcd
</code></pre></div><p>*<strong>/etc/dhcpcd.conf</strong>
You should find something like this. But it will be different based on your own network address space and other details.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Example static IP configuration:</span>
<span class=c1>#interface eth0</span>
<span class=c1>#static ip_address=192.168.0.10/24</span>
<span class=c1>#static ip6_address=fd51:42f8:caae:d92e::ff/64</span>
<span class=c1>#static routers=192.168.0.1</span>
<span class=c1>#static domain_name_servers=192.168.0.1 8.8.8.8 fd51:42f8:caae:d92e::1</span>
</code></pre></div><p>The new information should look similar to this.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Example static IP configuration:</span>
interface eth0
<span class=c1>#static ip_address=192.168.0.10/24</span>
<span class=c1>#static ip6_address=fd51:42f8:caae:d92e::ff/64</span>
<span class=c1>#static routers=192.168.0.1</span>
<span class=c1>#static domain_name_servers=192.168.0.1 8.8.8.8 fd51:42f8:caae:d92e::1</span>
static <span class=nv>domain_name_servers</span><span class=o>=</span>192.168.11.10 192.168.11.20
static <span class=nv>domain_search</span><span class=o>=</span>example.com
</code></pre></div><ul><li>Uncomment your <strong>interface</strong> line</li><li>Uncomment your <strong>static domain_name_servers</strong> and list the IP Addresses of your name servers.</li><li>Optionally add your <strong>domain_search</strong>. This will allow you to access machines using the single host name.</li></ul><h3 id=the-secondary-name-server>The secondary name server.</h3><p>This server should have the order of the <strong>domain_name_servers</strong> reversed so that it does its lookup locally by default. Otherwise it will always query the primary name server.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>static <span class=nv>domain_name_servers</span><span class=o>=</span>192.168.11.20 192.168.11.10
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ssh host1
</code></pre></div><p>will be the same as:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ssh host1.example.com
</code></pre></div><p>in the case where domain_search=example.com</p><p>Restart the dhcpcd service:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl restart dhcpcd
</code></pre></div><p>Your <strong>/etc/resolv.conf</strong> should now reflect these changes but retain some of its original settings.
This will need to be done to all machines in your network so that they know to use your new DNS server. Alternatively you could change your DHCP server&rsquo;s setting to provide your internal name server addresses.
This is generally going to be done on your router.</p><p>You now should have a functioning caching name server.</p><h2 id=time-to-get-authoritative>Time to get Authoritative!</h2><p>Having a caching name server is nice. But it&rsquo;s not really that useful. The real benefit comes from controlling your own domain within your network. As well as being able to provide reverse DNS entries.</p><h3 id=what-are-reverse-dns-entries>What are reverse DNS entries?</h3><p>We have all probably watched a police drama where they use a reverse lookup on a phone number to get a name or address. Its basically the same.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dig -x 192.168.11.1
</code></pre></div><p>Response:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>...
...
<span class=p>;;</span> ANSWER SECTION:
1.11.168.192.in-addr.arpa. <span class=m>86400</span> IN	PTR	router.example.com.
..
..
</code></pre></div><p>Have you ever noticed that sometimes initial connections to hosts can be slow? This is often caused by a failed reverse DNS lookup.</p><p>The other benefit, is that reverse DNS is another way to document your network. Sure a spreadsheet is useful.
But sometimes a simple <strong>dig -x</strong> will give you the information you need provided you keep your zone files up to date.</p><h3 id=setting-a-reverse-zone-file>Setting a Reverse Zone file.</h3><p>Let&rsquo;s copy the db.empty to a new file called db.192.168.11</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cp db.empty db.192.168.11
</code></pre></div><p>Original file:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=p>;</span> BIND reverse data file <span class=k>for</span> empty rfc1918 zone
<span class=p>;</span>
<span class=p>;</span> DO NOT EDIT THIS FILE - it is used <span class=k>for</span> multiple zones.
<span class=p>;</span> Instead, copy it, edit named.conf, and use that copy.
<span class=p>;</span>
<span class=nv>$TTL</span>	<span class=m>86400</span>
@	IN	SOA	localhost. root.localhost. <span class=o>(</span>
			      1		<span class=p>;</span> Serial
			 604800		<span class=p>;</span> Refresh
			  86400		<span class=p>;</span> Retry
			2419200		<span class=p>;</span> Expire
			  <span class=m>86400</span> <span class=o>)</span>	<span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
@	IN	NS	localhost.
</code></pre></div><p>Let&rsquo;s delete the first 5 lines. We don&rsquo;t need these comments.
Next we are going to edit the <strong>&ldquo;localhost. root.localhost."</strong> portion
replace <strong>localhost.</strong> with <strong>ns1.example.com.</strong> and <strong>root.localhost.</strong> with <strong>root.example.com.</strong></p><p>The line should now look like:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>@	IN	SOA	ns1.example.com. root.example.com. <span class=o>(</span>

</code></pre></div><h3 id=what-does-this-mean>What does this mean?</h3><p>We are saying that ns1.example.com is the Start Of Authority for this zone record. And the contact email address for this zone is <a href=mailto:root@example.com>root@example.com</a></p><p>An important point here. <strong>Always</strong> update the serial number when you edit any zone files. If you forget to do this. The zone data will not propagate to the name servers correctly. The general format that has been used for the serial number is in the form of: <strong>&lsquo;YEARMONTHDATESEQUENCE&rsquo;</strong>. Assume todays date was <em>20201122</em> the Serial would be <strong>2020112201</strong>. If you edit the zone file on that date. If you edit it a second time on the same day, then increment the sequence. The serial would now be <strong>2020112202</strong>.</p><p>Now that we know this. Edit the serial to match your actual date. Try and keep everything nicely lined up. Note that the file uses tab spacing.</p><p>After editing you want to have someting that looks like the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>$TTL</span>	<span class=m>86400</span>
@	IN	SOA	ns1.example.com. root.example.com. <span class=o>(</span>
	                 2020112201		<span class=p>;</span> Serial
			             604800		<span class=p>;</span> Refresh
			              86400		<span class=p>;</span> Retry
			            2419200		<span class=p>;</span> Expire
                          <span class=m>86400</span> <span class=o>)</span>  	<span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
<span class=p>;</span> Name servers
	 IN	NS	  ns1.example.com.
	 IN	NS	  ns2.example.com.

1	IN	PTR	 router.example.com.
..
..
<span class=m>35</span>   IN     PTR     hassio.example.com.
<span class=m>40</span>   IN     PTR     printer.example.com.
</code></pre></div><p><strong>Note:</strong><br>These lines end with a <strong>.</strong>(period / full stop). This tells DNS not to append to the record.</p><p>Add any other records that you want to have in your reverse DNS records.</p><p>Next lets make DNS aware of this this <strong>db.192.168.11</strong> file.</p><p>For simplicity edit the <strong>zones.rfc1918</strong> file and add these lines:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>zone <span class=s2>&#34;11.168.192.in-addr.arpa&#34;</span> <span class=o>{</span>
  <span class=nb>type</span> master<span class=p>;</span>
  file <span class=s2>&#34;/etc/bind/db.192.168.11&#34;</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></div><p>just above the line shown here.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>zone <span class=s2>&#34;168.192.in-addr.arpa&#34;</span> <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;/etc/bind/db.empty&#34;</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</code></pre></div><p>Next we want to add our more standard forward lookups.</p><p>Again copy the db.empty to a file called <strong>db.example.com</strong>. Make the same basic edits for the SOA line and ; serial. Then add your host records.</p><p>Here is the example.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>$TTL</span>	<span class=m>604800</span>
@	IN	SOA	ns1.example.com. root.example.com. <span class=o>(</span>
		                    2020112201		<span class=p>;</span> Serial
			                    604800		<span class=p>;</span> Refresh
			                     86400		<span class=p>;</span> Retry
			                   2419200		<span class=p>;</span> Expire
			                    <span class=m>604800</span> <span class=o>)</span>  	<span class=p>;</span> Negative Cache TTL


	IN     NS	ns1.example.com.
	IN     NS	ns2.example.com.

ns1.example.com.		IN	A	192.168.11.10
ns2.example.com.		IN	A	192.168.11.20

hassio.example.com.	IN	A	192.168.11.35
printer.example.com.   IN    A    192.168.11.40

<span class=p>;</span> External Servers/Services
blog.example.com.      IN    CNAME ghs.google.com.
bogus.example.com.     IN    A    203.X.X.X
</code></pre></div><h3 id=the-big-gotcha-that-follows>The big gotcha that follows.</h3><p>The pickle in this pie is going to be if you use the same domain for your internal network and anything that you have hosted outside on the internet. You need to duplicate these entries in your new zone file.</p><p>Let&rsquo;s say you are using Google&rsquo;s Blogger to host a site.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>https://blog.example.com
</code></pre></div><p>This resolves to:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=p>;;</span> ANSWER SECTION:
blog.example.com.	3599	IN	CNAME	ghs.google.com.
ghs.google.com.		299	IN	A	172.217.175.83
</code></pre></div><p>We need to duplicate this sort of entry in our new zone file.
If you were looking carefully you might have noticed the entry above under <strong>External Servers/Services</strong></p><h3 id=adding-the-zone-file-to-the-dns-server>Adding the zone file to the DNS Server.</h3><p>Add this db file to <strong>named.conf.local</strong> just below:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>//
// Do any <span class=nb>local</span> configuration here
//
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>zone <span class=s2>&#34;example.com&#34;</span> <span class=o>{</span>
	<span class=nb>type</span> master<span class=p>;</span>
	file <span class=s2>&#34;/etc/bind/db.example.com&#34;</span><span class=p>;</span>
	//allow-transfer <span class=o>{</span> 192.168.11.20<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></div><p>Since there is no secondary DNS server yet. We can leave the <strong>allow-transfer</strong> as a comment. Uncomment this after you have a secondary server configured.</p><p>You can again use <strong>named-checkconf</strong> to check for issues. Then restart the bind9 with <strong>systemctl reload bind9</strong></p><p>You should now be able to use <strong>dig</strong> or <strong>nslooup</strong> to find hosts on your network.</p><p>You now have a fully functioning primary cache and authoritative DNS server.</p><p>The next step would be to set up your secondary DNS server to provide redundancy. You could also setup a third or fourth.</p><p>Do keep in mind this is only accessible from within your home network. And does not work when you are connected to external networks. So it does not affect any of your existing externally hosted services.</p><h2 id=adding-a-secondary-name-server>Adding a Secondary Name Server.</h2><p>This will involve using the same steps to set up a caching server that we did when setting up NS1.
So I will list these commands in quick succession.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>apt update <span class=o>&amp;&amp;</span> apt upgrade
apt install bind9 dnsutils
</code></pre></div><p>Create the <strong>named.conf.acl</strong> file in <strong>/etc/bind/</strong> and add your acl data</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>acl <span class=s2>&#34;internal&#34;</span> <span class=o>{</span>
	192.168.11.0/24<span class=p>;</span>
	127.0.0.1<span class=p>;</span>
	::1<span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></div><p>Get the <strong>named.conf.acl</strong> included into <strong>named.conf</strong> by adding the following to <strong>named.conf</strong> near the top.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>include <span class=s2>&#34;/etc/bind/named.conf.acl&#34;</span><span class=p>;</span>
</code></pre></div><p>Edit <strong>named.conf.options</strong> as we did previously. But replace .10 with .20 to match the servers IP address.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>options <span class=o>{</span>
	directory <span class=s2>&#34;/var/cache/bind&#34;</span><span class=p>;</span>

	recursion yes<span class=p>;</span>
	allow-recursion <span class=o>{</span> internal<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
	listen-on <span class=o>{</span> 127.0.0.1<span class=p>;</span> 192.168.11.20<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
	allow-transfer <span class=o>{</span> none<span class=p>;</span> <span class=o>}</span><span class=p>;</span>

</code></pre></div><p>Updated your forwarders</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>forwarders <span class=o>{</span>
  8.8.8.8<span class=p>;</span>
  xx.xx.xx.xx<span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></div><p>And add the following if you are using forwarders.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>//dnssec-validation auto<span class=p>;</span>
dnssec-validation no<span class=p>;</span>
</code></pre></div><p>Edit the <em>named.conf.local</em>* to include **zones.rfc1918**</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>// Consider adding the <span class=m>1918</span> zones here, <span class=k>if</span> they are not used in your
// organization
include <span class=s2>&#34;/etc/bind/zones.rfc1918&#34;</span><span class=p>;</span>

</code></pre></div><p>But dont do anything more at this stage. This should result in a working cache server.</p><p>Enable and start Bind9</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl <span class=nb>enable</span> bind9
systemctl start bind9
</code></pre></div><p>Feel free to test using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>nslookup @localhost www.google.com
</code></pre></div><h2 id=time-to-tell-the-primary-server-to-share-its-zone-data-with-the-secondary-and-to-tell-the-secondary-to-expect-zones-from-the-primary>Time to tell the primary server to share its zone data with the secondary. And to tell the secondary to expect zones from the primary.</h2><p>On your primary server let&rsquo;s edit the <strong>named.conf.options</strong> file and add the following:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>notify yes;
also-notify { 192.168.11.20; };
</code></pre></div><p>This means that when ever we edit our zone files on the primary name server, the secondary will be notified and will pull the updated zone information without waiting for the zones TTL (Time To Live) to expire.</p><p>Previously you would have setup your zone files. We will now edit them to add zone transfer ability.</p><p>Edit <strong>zones.rfc1918</strong> and add the <strong>allow-transfer</strong> line.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>zone &#34;11.168.192.in-addr.arpa&#34; {
  type master;
  file &#34;/etc/bind/db.192.168.11&#34;;
  allow-transfer { 192.168.11.20; };
};
</code></pre></div><p>Add the same <strong>allow-transer</strong> line to any other zone files you have created.</p><p>Check the configuration and reload.
Reload bind9</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>systemctl reload bind9
</code></pre></div><p>We can now turn our attention to the secondary name server and configure it to get zone data from the primary which it make it authoritative for our zones.</p><p>In this case we just need to update the <strong>named.conf.local</strong> file so that the server knows about the zones. Add the following configuration.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>//
// Do any local configuration here
//
zone &#34;example.com&#34; {
    type slave;
    file &#34;db..example.com&#34;;
    masters { 192.168.11.10; };
};

zone &#34;11.168.192.in-addr.arpa&#34; {
    type slave;
    file &#34;db.192.168.11&#34;;
    masters { 192.168.11.10; };
};
</code></pre></div><p>This basically says that for the zone file we are a secondary (slave) and that the source of all truth is our primary server.</p><p>You can reload bind9</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>systemctl reload bind9
</code></pre></div><p>or</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>rndc reload
</code></pre></div><p>To finish up we need to get our <strong>/etc/resolv.conf</strong> updated using the method you used before. Just remember to list your secondary ip address before the primary so that it uses itself first.</p><p>That should conclude getting the name servers up and running and answering queries.</p><p>You still need to configure your network equipment to use these new servers.</p><h2 id=references>References:</h2><ul><li><a href=https://jensd.be/160/linux/split-horizon-dns-masterslave-with-bind>Split Horizon Master/Slave</a></li><li><a href=https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-debian-9>Digital Ocean DNS Configuration</a></li></ul><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f&text=Bind%20DNS%20Setup&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f&title=Bind%20DNS%20Setup" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f&title=Bind%20DNS%20Setup" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f&title=Bind%20DNS%20Setup" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fbas-man.github.io%2fdocs%2fbind-dns-setup%2f&description=Bind%20DNS%20Setup" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://bas-man.github.io/docs/gmail-zapier-line-notify/ data-toggle=tooltip data-placement=top title="Gmail Zapier LINE Notify">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://github.com/Bas-Man title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://dev.to/basman title=Dev><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-dev fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://flipboard.com/@baspann/coding-kq8v8rh8z?from=share%25!%28EXTRA%20string=%29" title=Flipboard><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-flipboard fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Bas-Man
&nbsp;&bull;&nbsp;&copy;
2020 - 2021
&nbsp;&bull;&nbsp;
<a href=https://bas-man.github.io/>Bas-Man's Musings</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://bas-man.github.io/js/main.js></script><script src=https://bas-man.github.io/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://bas-man.github.io/js/load-photoswipe.js></script><div class=cookie-container><p>By using this site, you agree to our use of cookies.
We use cookies on this website to give you the best experience on our
site. To find out more, read our <a href=/privacy/>privacy</a> policy.</p><button class=cookie-btn>
Okay</button></div><script src=/js/custom.js></script></body></html>